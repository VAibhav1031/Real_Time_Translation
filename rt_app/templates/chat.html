{% extends "layout.html" %}
{% block content %}

<div class="chat-meta">
    Room: <b>{{ room }}</b> |
    Role: <b>{{ role }}</b> |
    Language: <b>{{ lang }}</b>
</div>

<div class="chat-box" id="chatBox"></div>

<div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type your message...">
    <button class="primary" onclick="sendMessage()">Send</button>
</div>

<br>

<div style="display: flex; gap: 10px;">
    <button class="secondary" onclick="generateSummary()">Generate Summary</button>
    <button class="secondary" onclick="exitRoom()">Exit Room</button>
</div>

<!-- Summary Output -->
<div id="summaryBox" style="
    display: none;
    margin-top: 15px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fafafa;
    white-space: pre-wrap;
    font-size: 0.9rem;
">
</div>

<script>
const room = "{{ room }}";
const role = "{{ role }}";
const language = "{{ lang }}";

async function loadMessages() {
    const res = await fetch(`/messages/${room}`);
    const data = await res.json();

    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";

    data.data.forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(msg.role.toLowerCase());
        div.innerText = `[${msg.role}] ${msg.translated_text}`;
        chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;

    await fetch("/send_message", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            room: room,
            role: role,
            text: text,
            language: language
        })
    });

    input.value = "";
    loadMessages();
}

async function generateSummary() {
    const summaryBox = document.getElementById("summaryBox");
    summaryBox.style.display = "block";
    summaryBox.innerText = "Generating summary...";

    const res = await fetch(`/summary/${room}`);
    const data = await res.json();

    summaryBox.innerText = data.summary || "No summary available.";
}

function exitRoom() {
    if (confirm("Exit this conversation?")) {
        window.location.href = "/";
    }
}

setInterval(loadMessages, 2000);
loadMessages();
</script>

{% endblock %}

